---

- import_playbook: ka-init/init.yml

- hosts: virthost
  become: true
  become_user: root
  tasks:
    - set_fact:
        path_bootstrap_image_source: "/home/images/bootstrapkubemaster/bootstrapkubemaster.qcow2"
        path_bootstrap_image_dest: "/home/images/bootstrapped.qcow2"
        spare_disk_attach: false
        virtual_machines:
          - name: bootstrapkubemaster
            node_type: master
        bootstrap_common_args: ""
        ssh_proxy_enabled: false
        ssh_proxy_user: root

- import_playbook: virthost-setup.yml

- hosts: virthost
  tasks:

    - name: Get created VM's IP to use in dynamic inventory
      set_fact:
        bootstrap_use_ip: "{{ vm_ips_dict.bootstrapkubemaster }}"

    - name: "Add proxy command if set"
      set_fact:
        bootstrap_common_args: >
          -o ProxyCommand="ssh{% if ssh_proxy_port is defined %} -p {{ ssh_proxy_port }}{% endif %} -W %h:%p {{ ssh_proxy_user }}@{{ ssh_proxy_host }}"
      when: "ssh_proxy_enabled"

    - name: Add a host to the inventory so we can install kube deps on it.
      add_host:
        hostname: "bootstrapkubemaster"
        ansible_ssh_host: "{{ bootstrap_use_ip }}"
        groups: master
        ansible_ssh_private_key_file: "{{ vm_ssh_key_path }}"
        ansible_ssh_common_args: "{{ bootstrap_common_args }}"
        ansible_user: "centos"

- hosts: all
  tasks:
    - name: Express that we'd like to not init the cluster, initialize other variables.
      set_fact:
        skip_init: true
        pre_pull_images:
          - "centos:centos7"
          # - "centos:tools"
          - "nfvpe/multus:deviceid"
          - "dougbtv/centos-network"
          # Update this image for userspace.
          - "bmcfall/vpp-centos-userspace-cni:0.4.0"
          - "quay.io/coreos/flannel:v0.10.0-amd64"
          - "nfvpe/virtdp:latest"
          - "nfvpe/kube-api-server-amd64:deviceid"

- import_playbook: kube-install.yml

- hosts: master
  become: true
  become_user: root
  tasks:

    - name: Install tmux
      yum:
        name: tmux
        state: present

    - name: Download tmate binary 
      unarchive:
        src: https://github.com/tmate-io/tmate/releases/download/2.2.1/tmate-2.2.1-static-linux-amd64.tar.gz
        dest: /tmp/
        remote_src: yes        

    - name: Move tmate binary 
      shell: >
        mv /tmp/tmate-2.2.1-static-linux-amd64/tmate /usr/local/bin/tmate

    - name: Gen an ssh key
      shell: >
        ssh-keygen -b 2048 -t rsa -f /home/centos/.ssh/id_rsa -q -N ""

    - name: Clone virt-network-device-plugin locally
      git:
        repo: https://github.com/zshi-redhat/virt-network-device-plugin.git
        dest: "/home/centos/virt-network-device-plugin"
        force: yes

    - name: Clone Multus locally
      git:
        repo: https://github.com/intel/multus-cni.git
        dest: /home/centos/multus-cni
        force: yes

    - name: Modify Multus to use :deviceid tagged image (for SR-IOV tutorial)
      shell: >
        sed -i -e 's|nfvpe/multus:latest|nfvpe/multus:deviceid|' /home/centos/multus-cni/images/multus-daemonset.yml

    - name: Pull kubeadm images
      shell: >
        kubeadm config images pull --kubernetes-version={{ kubeadm_version }}

    - name: Pre-pull necessary docker images
      shell: >
        docker pull {{ item }}
      with_items: "{{ pre_pull_images }}"

    - name: Jimmy in the custom api server image
      shell: >
        docker tag k8s.gcr.io/kube-apiserver-amd64:v1.11.2 k8s.gcr.io/kube-apiserver-amd64:orig.v1.11.2;
        docker rmi k8s.gcr.io/kube-apiserver-amd64:v1.11.2;
        docker tag docker.io/nfvpe/kube-api-server-amd64:deviceid k8s.gcr.io/kube-apiserver-amd64:v1.11.2

    - name: Re-install cloud-init goodies
      yum:
        name: "{{ item }}"
        state: present
      with_items:
        - cloud-init
        - cloud-utils
        - cloud-utils-growpart

    - name: Delete the cloud-init dir and re-create dir
      file: 
        path: /var/lib/cloud
        state: "{{ item }}"
      with_items:
        - absent
        - directory

    - name: Remove hostname
      shell: >
        hostnamectl set-hostname ""

    - name: "Power off machine"
      shell: "sleep 2 && poweroff"
      async: 1
      poll: 0

- hosts: virthost
  tasks:

    - name: Ensure virt-sysprep is installed
      yum:
        name: "libguestfs-tools-c"
        state: present

    - name: Copy bootstrapped image
      shell: >
        cp -f {{ path_bootstrap_image_source }} {{ path_bootstrap_image_dest }}

    # http://manpages.ubuntu.com/manpages/xenial/man1/virt-sysprep.1.html
    - name: Run virt-sysprep to strip persistent stuff from image
      shell: >
        virt-sysprep -a {{ path_bootstrap_image_dest }}

    - debug:
        msg: "Bootstrapped image qcow2 copied to: {{ path_bootstrap_image_dest }}"
