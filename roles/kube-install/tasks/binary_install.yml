---

- name: Check for download complete semaphor
  stat:
    path: "{{ kubectl_home }}/.kube-binary-download-complete"
  register: download_complete_semaphor

- name: Delete existing binaries when necessary
  file:
    path: "{{ item.path }}"
    state: absent
  with_items:
    - path: /usr/bin/kubelet
      url_is_set: "{{ binary_kubelet_url is defined }}"
    - path: /usr/bin/kubectl
      url_is_set: "{{ binary_kubectl_url is defined }}"
    - path: /usr/bin/kubeadm
      url_is_set: "{{ binary_kubeadm_url is defined }}"
  when: >
    item.url_is_set and
    (download_complete_semaphor.stat.exists == False or binary_install_force_redownload)

- name: make sure wget is installed
  yum:
    name: wget

- name: Download kubelet
  shell: |
    wget -O /usr/bin/kubelet {{ binary_kubelet_url }}
  when: binary_kubelet_url is defined

- name: Download kubectl
  shell: |
    wget -O /usr/bin/kubectl {{ binary_kubectl_url }}
  when: binary_kubectl_url is defined

- name: Download kubeadm
  shell: |
    wget -O /usr/bin/kubeadm {{ binary_kubeadm_url }}
  when: binary_kubeadm_url is defined

- name: Make sure binaries have proper permission
  file:
    path: "{{ item }}"
    mode: 0755
  with_items:
    - /usr/bin/kubelet
    - /usr/bin/kubectl
    - /usr/bin/kubeadm

- name: Mark download complete
  file:
    path: "{{ kubectl_home }}/.kube-binary-download-complete"
    state: directory
